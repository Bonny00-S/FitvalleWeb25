@{
    ViewData["Title"] = "Restablecer contraseña";
}

<div class="container mt-5">
    <h2 class="text-center mb-4 text-primary">Restablecer contraseña</h2>

    @if (ViewBag.Success != null)
    {
        <div class="alert alert-success text-center">@ViewBag.Success</div>
    }

    <div class="row justify-content-center">
        <div class="col-md-6">
            <form asp-action="ResetPasswordConfirm" method="post" class="border rounded p-4 shadow-sm bg-light">
                @Html.AntiForgeryToken()

                <input type="hidden" name="oobCode" value="@ViewBag.OobCode" />

                <div class="mb-3">
                    <label class="form-label fw-bold">Nueva contraseña</label>
                    <input type="password" name="newPassword" id="newPassword" class="form-control" required />
                    <div id="passwordHelp" class="form-text mt-2">
                        <ul class="list-unstyled">
                            <li id="reqLength" class="text-danger">• Al menos 6 caracteres</li>
                            <li id="reqUpper" class="text-danger">• Una letra mayúscula</li>
                            <li id="reqLower" class="text-danger">• Una letra minúscula</li>
                            <li id="reqNumber" class="text-danger">• Un número</li>
                            <li id="reqSpecial" class="text-danger">• Un carácter especial (!$%^&*)</li>
                        </ul>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Confirmar nueva contraseña</label>
                    <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" required />
                    <small id="matchError" class="text-danger d-none">Las contraseñas no coinciden.</small>
                </div>

                <button type="submit" id="btnSubmit" class="btn btn-primary w-100" disabled>
                    Confirmar nueva contraseña
                </button>

                <div asp-validation-summary="All" class="text-danger mt-3"></div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const newPass = document.getElementById("newPassword");
        const confirmPass = document.getElementById("confirmPassword");
        const submitBtn = document.getElementById("btnSubmit");

        const reqs = {
            length: document.getElementById("reqLength"),
            upper: document.getElementById("reqUpper"),
            lower: document.getElementById("reqLower"),
            number: document.getElementById("reqNumber"),
            special: document.getElementById("reqSpecial"),
            match: document.getElementById("matchError")
        };

        function validatePassword() {
            const val = newPass.value;
            const conf = confirmPass.value;

            const valid = {
                length: val.length >= 6,
                upper: /[A-Z]/.test(val),
                lower: /[a-z]/.test(val),
                number: /\d/.test(val),
                special: /[\W_]/.test(val),
                match: val && conf && val === conf
            };

            for (const key of ["length", "upper", "lower", "number", "special"]) {
                reqs[key].classList.toggle("text-success", valid[key]);
                reqs[key].classList.toggle("text-danger", !valid[key]);
            }

            reqs.match.classList.toggle("d-none", valid.match || !conf);
            reqs.match.classList.toggle("text-danger", !valid.match && conf);

            const allValid = Object.values(valid).every(Boolean);
            submitBtn.disabled = !allValid;
        }

        newPass.addEventListener("input", validatePassword);
        confirmPass.addEventListener("input", validatePassword);
    </script>
}