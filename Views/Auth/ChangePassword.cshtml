@{
    Layout = ViewBag.Rol;
    ViewData["Title"] = "Cambio de contraseña";
}

<div class="h-screen flex justify-center items-start pt-16 bg-[var(--color-background)] font-[Poppins] animate__animated animate__fadeIn">

    <div class="card-fitvalle max-w-md w-full p-8 rounded-2xl shadow-2xl border border-[var(--color-primary)]/30 bg-[var(--color-surface)] text-[var(--color-text-primary)]">
        <h2 class="text-3xl font-bold text-center mb-6 text-[var(--color-primary)]">Cambio de Contraseña</h2>

        <form asp-action="ChangePassword" method="post" class="space-y-6">
            @Html.AntiForgeryToken()

            <!-- Nueva contraseña -->
            <div>
                <label for="newPassword" class="block text-sm font-semibold mb-1 text-[var(--color-text-secondary)]">
                    Nueva contraseña
                </label>
                <input type="password" name="newPassword" id="newPassword" required
                       class="w-full px-4 py-2 rounded-lg border border-[var(--color-primary)]/40 bg-[var(--color-background)] text-[var(--color-text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] transition" />

                <ul class="text-sm mt-2 space-y-1 text-[var(--color-text-secondary)]">
                    <li id="reqLength">• Al menos 6 caracteres</li>
                    <li id="reqUpper">• Una letra mayúscula</li>
                    <li id="reqLower">• Una letra minúscula</li>
                    <li id="reqNumber">• Un número</li>
                    <li id="reqSpecial">• Un carácter especial (!#$%^&*)</li>
                </ul>
            </div>

            <!-- Confirmar contraseña -->
            <div>
                <label for="confirmPassword" class="block text-sm font-semibold mb-1 text-[var(--color-text-secondary)]">
                    Confirmar nueva contraseña
                </label>
                <input type="password" name="confirmPassword" id="confirmPassword" required
                       class="w-full px-4 py-2 rounded-lg border border-[var(--color-primary)]/40 bg-[var(--color-background)] text-[var(--color-text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] transition" />
                <span id="matchError" class="text-red-400 text-sm hidden">
                    Las contraseñas no coinciden.
                </span>
            </div>

            <!-- Botones -->
            <div class="flex justify-between items-center pt-4">
                @if (ViewBag.RolDashboard == "admin")
                {
                    <a asp-action="Dashboard" asp-controller="Admin"
                       class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white font-semibold px-5 py-2 rounded-md shadow transition inline-flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Cancelar
                    </a>
                }
                else
                {
                    <a asp-action="Dashboard" asp-controller="Coach"
                       class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white font-semibold px-5 py-2 rounded-md shadow transition inline-flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Cancelar
                    </a>
                }
                <button type="submit" id="btnSubmit" disabled
                        class="bg-white text-[var(--color-primary)] font-semibold px-5 py-2 rounded-md shadow transition disabled:opacity-50 hover:bg-[var(--color-surface)] border border-[var(--color-primary)]">
                    <i data-lucide="key-round" class="w-4 h-4"></i> Cambiar contraseña
                </button>
            </div>

            <div asp-validation-summary="All" class="text-sm text-yellow-300 mt-3"></div>
        </form>
    </div>
</div>

<!-- Modal de éxito -->
@if (ViewBag.Success != null)
{
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate__animated animate__fadeIn">
        <div class="bg-[var(--color-surface)] rounded-2xl p-6 max-w-sm text-center shadow-xl border border-[var(--color-primary)]/40 text-[var(--color-text-primary)]">
            <h3 class="text-lg font-bold text-[var(--color-primary)] mb-4">¡Éxito!</h3>
            <p class="text-[var(--color-text-secondary)] mb-6">@ViewBag.Success</p>

            @if (ViewBag.RolDashboard == "admin")
            {
                <a asp-action="Dashboard" asp-controller="Admin"
                   class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white px-5 py-2 rounded-md transition inline-block">
                    Aceptar
                </a>
            }
            else
            {
                <a asp-action="Dashboard" asp-controller="Coach"
                   class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white px-5 py-2 rounded-md transition inline-block">
                    Aceptar
                </a>
            }
        </div>
    </div>
}

@section Scripts {
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();

        const newPass = document.getElementById("newPassword");
        const confirmPass = document.getElementById("confirmPassword");
        const submitBtn = document.getElementById("btnSubmit");
        const matchError = document.getElementById("matchError");

        const rules = {
            reqLength: val => val.length >= 6,
            reqUpper: val => /[A-Z]/.test(val),
            reqLower: val => /[a-z]/.test(val),
            reqNumber: val => /\d/.test(val),
            reqSpecial: val => /[\W_]/.test(val)
        };

        function validatePassword() {
            const val = newPass.value;
            const conf = confirmPass.value;

            Object.entries(rules).forEach(([id, test]) => {
                const el = document.getElementById(id);
                el.classList.toggle("text-green-400", test(val));
                el.classList.toggle("text-[var(--color-text-secondary)]", !test(val));
            });

            const valid = Object.values(rules).every(fn => fn(val)) && val === conf;
            matchError.classList.toggle("hidden", !(val && conf && val !== conf));
            submitBtn.disabled = !valid;
        }

        newPass.addEventListener("input", validatePassword);
        confirmPass.addEventListener("input", validatePassword);
    </script>
}
